---
title: "Zoom City Carbon Model"
author : "Berlin"
output: 
  flexdashboard::flex_dashboard:
    source_code: "https://github.com/ByMaxAnjos"
    vertical_layout: scroll
    social: menu
    theme: yeti
---

```{r setup, include=FALSE}
# Importing libraries
if (!require("pacman")) install.packages("pacman")
pacman::p_load(flexdashboard, shiny, tidyverse, data.table, highcharter, gt, htmltools,leaflet, sf, plotly, crosstalk, viridis, DT)

library(flexdashboard)
library(shiny)
library(tidyverse)
library(data.table)
library(highcharter)
library(sf)
library(gt)
library(htmltools)
library(viridis)
library(leaflet)
library(plotly)
library(crosstalk)
library(DT)

```

Sidebar {.sidebar}
=====================================
The **Zoom City Carbon Model - ZCCM** is a multi-layered, bottom-up approach for mapping and quantifying the total CO2 emissions in a city at high spatial and temporal resolutions, down to 100-meter grids or street level, and sectorial resolution. The model identifies major CO2 emitters and sinks, such as traffic vehicles, building energy consumption, human respiration, and vegetation/soils, and estimates their emission patterns and changes over time.

This **Emission Geographic Information platform** is designed to communicate the outcomes of the {ZCCM} to users, stakeholders, the research community, and the public in general. It enables the visualization of zoom CO2 maps and summary statistics of emissions in an interactive way.

This **Flexdashboard R** leverages traffic estimates from the ZCCM::traffic model https://github.com/ByMaxAnjos/CO2-traffic-emissions to showcase the spatio-temporal variability of CO2 emissions at the city level. With this tool, users can explore detailed street-level emissions, emissions associated with Open Street Map features, and temporal patterns such as hourly time series, daily cycles, and monthly totals. 

**Author: Max Anjos, 2023.** [maxanjos\@campus.ul.pt](mailto:maxanjos@campus.ul.pt){.email}, Institute of Ecology Chair of Climatology, Technical University of Berlin.

# iMap {data-icon="fa-map"}

### Total Emissions {data-height=500}

```{r fig.height=5}
#Read road network ESRI shapefile from TomTom
df <- list.files(path = "output_citystreet/",     # Identify all csv files in folder
                  pattern = "*CO2street.Rds", full.names = TRUE) %>%
  lapply(readRDS) %>%                                            # Open and store all files in list
  bind_rows () %>%                                             # Combine data sets into one data.frame
  setkey(date)

iNetRoad <- st_read("shps/iNetroad.shp")

# Mapping 1
imap <- df %>%
  group_by(osm_id) %>%
  summarise(tCO2 = round(sum(ECO2_gmh)/1000, digits = 2)) %>%
  #filter(tCO2 > 100) %>%
  inner_join(iNetRoad, by= "osm_id") %>%
  dplyr::select(tCO2, name, geometry) %>%
  st_as_sf() %>%
  st_transform(crs = 4326) %>% 
  group_by(name) %>% 
  summarise(tCO2=sum(tCO2),
            geometry = st_union(geometry))
  # mutate(name = ifelse(is.na(name), "SEM", name)) %>%
  # subset(name !="SEM") %>%
  

pal_line <- colorFactor(palette = "plasma", domain = NULL)

imap$labels <- paste0(
  "<strong> name: </strong> ",
  imap$name, "<br/> ",
  "<strong> tCO2: </strong> ",
  imap$tCO2, "<br/> "
) %>%
  lapply(htmltools::HTML)

leaflet(imap) %>%
  addTiles(group = "OpenStreeMap.Default") %>% 
  addProviderTiles("Esri.WorldImagery", group = "Esri.WorldImagery") %>%
  addProviderTiles("CartoDB.DarkMatter", group = "CartoDB.DarkMatter") %>%
  addTiles() %>%
  #setView(lng = 0, lat = 30, zoom = 2) %>%
  addPolylines(
    #fillColor = "tCO2",
    color = ~ pal_line(tCO2),
    fillOpacity = 0.8,
    label = ~labels,
    highlight = highlightOptions(
      color = "black",
      bringToFront = TRUE
    )
  ) %>%
  leaflet::addLegend(pal = pal_line, values = "", opacity = 0.8, title = "tCO2/ m2/month", group = "Total of tCO2") %>% 
  # layers control
  addLayersControl(
    baseGroups = c("OpenStreeMap.Default", "Esri.WorldImagery", "CartoDB.DarkMatter"),
    position = "topleft",
    options = layersControlOptions(collapsed = TRUE)
  )
```

### Trend Emissions

```{r fig.height=5}

# Create tibble for our line plot.  
#trend <- fread("trend.csv")

trend <- df %>%
  group_by(date_day) %>%
  summarise(ktCO2 = round(sum(ECO2_gmh)/1000/1000, digits= 2))

highchart() %>% 
    hc_add_series(trend, hcaes(x = date_day, y = ktCO2, color = ktCO2), type = "spline") %>%
    hc_tooltip(crosshairs = TRUE, borderWidth = 1.5, headerFormat = "", pointFormat =
                 paste("Day: <b>{point.x}</b> <br> ktCO2: <b>{point.y}</b>")) %>%
    hc_title(text = "") %>% 
    hc_subtitle(text = "") %>%
    hc_xAxis(title = list(text = "Day")) %>%
    hc_yAxis(title = list(text = "Traffic emissions [ktCO2/day]"),
             allowDecimals = FALSE,
             plotLines = list(list(
                    color = "white", width = 1, dashStyle = "Dash", 
                    value = mean(trend$ktCO2),
                    label = list(text = "Mean = 10", 
                                 style = list(color = "white", fontSize = 11))))) %>%
    hc_legend(enabled = FALSE) %>% 
    hc_credits(enabled = TRUE, text = '@ZoonCityCarbonModel')%>% 
    hc_add_theme(hc_theme_google()) %>% 
  hc_exporting(enabled = TRUE)

```

# Summary Stats {data-orientation="rows" data-icon="fa-bar-chart"}

## Row {data-height="100"}

## Row 1 {data-height="500"}

### Total of traffic emissions [ktCO2/month]

```{r}
#mapCount <- fread("mapCount.csv")

mapCount <- df %>%
  group_by(osm_id) %>%
  summarise(ktCO2 = round(sum(ECO2_gmh)/1000/1000, digits = 2),
            ktC = round(sum(EC_gmh)/1000/1000, digits = 2),
            mean_cars = round(mean(cars), digits = 2))

valueBox(round(sum(mapCount$ktCO2), digits = 2),icon = "fa-users", color = "purple")
```

### Total of carbon [ktC/month]

```{r}

valueBox(round(sum(mapCount$ktC), digits = 2), icon="fa-users", color = "purple")
```

## Row 2 {.tabset .tabset-fade}

### Top CO2 Amenity sites

```{r fig.height=5}
#amenity <- fread("amenity.csv")

amenity <- df %>%
  subset(amenity !="other") %>%
  subset(amenity !="unknown") %>%
  group_by(amenity) %>%
  summarise(ktCO2 = round(sum(ECO2_gmh)/1000/1000, digits= 2)) %>%
  arrange(desc(ktCO2))

# Colors
custom_colors <- viridis::plasma(n = length(amenity$amenity))

# Amenity Open Street Map feature
amenity %>% 
  hchart('bar', hcaes(x = amenity, y = ktCO2, color = custom_colors)) %>% 
  hc_add_theme(hc_theme_google()) %>% 
  hc_tooltip(pointFormat = '<b>ktCO2: </b> {point.y} <br>') %>% 
  hc_title(text = 'Spatial association - Amenity',
           style = list(fontSize = '25px', fontWeight = 'bold')) %>% 
  hc_subtitle(text = 'Traffic emissions [ktCO2/month]',
              style = list(fontSize = '16px')) %>%
 hc_xAxis(title = "") %>%
 hc_yAxis(title = "") %>%
  hc_credits(enabled = TRUE, text = '@ZoomCityCarbonModel')%>% 
  hc_exporting(enabled = TRUE)

```

### Top CO2 Leisure sites

```{r fig.height=5}
#leisure <- fread("leisure.csv")
leisure <- df %>%
  subset(leisure !="other") %>%
  subset(leisure !="unknown") %>%
  group_by(leisure) %>%
  summarise(ktCO2 = round(sum(ECO2_gmh)/1000/1000, digits= 2)) %>%
  arrange(desc(ktCO2))


# Colors
custom_colors <- viridis::turbo(n = length(leisure$leisure))

# Leisure Open Street Map feature
leisure %>% 
  hchart('column', hcaes(x = leisure, y = ktCO2, color = custom_colors)) %>% 
  hc_add_theme(hc_theme_google()) %>% 
  hc_tooltip(pointFormat = '<b>ktCO2: </b> {point.y} <br>') %>% 
  hc_title(text = 'Spatial association - Leisure',
           style = list(fontSize = '25px', fontWeight = 'bold')) %>% 
  hc_subtitle(text = 'Traffic emissions [ktCO2/month]',
              style = list(fontSize = '16px')) %>% 
  hc_xAxis(title = "") %>%
  hc_yAxis(title = "") %>%
  hc_credits(enabled = TRUE, text = '@ZoomCityCarbonModel')%>% 
  hc_exporting(enabled = TRUE)

```

### Top CO2 Natural sites

```{r fig.height=5}
#natural <- fread("natural.csv")

natural <- df %>%
  subset(natural !="other") %>%
  subset(natural !="unknown") %>%
  group_by(natural) %>%
  summarise(ktCO2 = round(sum(ECO2_gmh)/1000/1000, digits= 2)) %>%
  arrange(desc(ktCO2))


# Colors
custom_colors <- viridis::viridis(n = length(natural$natural))

# Natural Open Street Map feature
natural %>% 
  hchart('bar', hcaes(x = natural, y = ktCO2, color = custom_colors)) %>% 
  hc_add_theme(hc_theme_google()) %>% 
  hc_tooltip(pointFormat = '<b>ktCO2: </b> {point.y} <br>') %>% 
  hc_title(text = 'Spatial association - Natural',
           style = list(fontSize = '25px', fontWeight = 'bold')) %>% 
  hc_subtitle(text = 'Traffic emissions [ktCO2/month]',
              style = list(fontSize = '16px')) %>% 
  hc_xAxis(title = "") %>%
  hc_yAxis(title = "") %>%
  hc_credits(enabled = TRUE, text = '@ZoomCityCarbonModel')%>% 
  hc_exporting(enabled = TRUE)

```

### Top CO2 Shop sites

```{r fig.height=5}
#shop <- fread("shop.csv")
shop <- df %>%
  subset(shop !="other") %>%
  subset(shop !="unknown") %>%
  group_by(shop) %>%
  summarise(ktCO2 = round(sum(ECO2_gmh)/1000/1000, digits= 2)) %>%
  arrange(desc(ktCO2))

# Colors
custom_colors <- viridis::inferno(n = length(shop$shop))

# Shop Open Street Map features
shop  %>% 
  hchart('column', hcaes(x = shop, y = ktCO2, color = custom_colors),
         options3d = list(enabled = TRUE, beta = 1, alpha = 1)) %>% 
         hc_add_theme(hc_theme_google()) %>% 
  hc_tooltip(pointFormat = '<b>ktCO2: </b> {point.y} <br>') %>% 
  hc_title(text = 'Spatial association - Shop',
           style = list(fontSize = '25px', fontWeight = 'bold')) %>% 
  hc_subtitle(text = 'Traffic emissions [ktCO2/month]',
              style = list(fontSize = '16px')) %>%
  hc_xAxis(title = "") %>%
  hc_yAxis(title = "") %>%
  hc_credits(enabled = TRUE, text = '@ZooomCityCarbonModel')%>% 
  hc_exporting(enabled = TRUE)

```

## Row 3 {data-height="300"}

### 

```{r}
OSM_road <- df %>%
  group_by(fclass) %>%
  subset(fclass !="other") %>% 
  subset(fclass !="unknown") %>% 
  summarise(ktCO2 = round(sum(ECO2_gmh)/1000/1000, digits= 2))

# Colors
custom_colors <- viridis::mako(n = length(OSM_road$fclass))

# Emissions by OSM road class
OSM_road %>% 
  hchart('pie', hcaes(x = fclass, y = ktCO2, color = custom_colors)) %>% 
  hc_add_theme(hc_theme_google()) %>% 
  hc_tooltip(pointFormat='<b>Proportion: </b> {point.percentage:,.2f}%') %>% 
  hc_title(text = 'Emissions by OSM road class',
           style = list(fontSize = '15px', fontWeight = 'bold')) %>% 
  hc_credits(enabled = TRUE, text = '@ZoomCityCarbonModel')%>% 
  hc_exporting(enabled = TRUE)
  
```

### 

```{r}

place <- df %>%
  group_by(place) %>%
  subset(place !="other") %>% 
  subset(place !="unknown") %>% 
  summarise(ktCO2 = round(sum(ECO2_gmh)/1000/1000, digits= 2))

# Colors
custom_colors <- viridis::cividis(n = length(place$place))

# Emissions by FRC road class
place %>% 
  hchart('pie', hcaes(x = as.factor(place), y = ktCO2, color = custom_colors)) %>% 
  hc_add_theme(hc_theme_google()) %>% 
  hc_tooltip(pointFormat='<b>Proportion: </b> {point.percentage:,.2f}%') %>% 
  hc_title(text = 'Emissions by OSM place',
           style = list(fontSize = '15px', fontWeight = 'bold')) %>% 
  hc_credits(enabled = TRUE, text = '@ZoomCityCarbonModel')%>% 
  hc_exporting(enabled = TRUE)
  
```

### 

```{r}
landuse <- df %>%
  group_by(landuse) %>%
  subset(landuse !="other") %>% 
  subset(landuse !="unknown") %>% 
  summarise(ktCO2 = round(sum(ECO2_gmh)/1000/1000, digits= 2))

# Colors
custom_colors <- viridis::rocket(n = length(landuse$landuse))

# Emissions by landuse
landuse %>% 
  hchart('pie', hcaes(x = landuse, y = ktCO2, color = custom_colors)) %>% 
  hc_add_theme(hc_theme_google()) %>% 
  hc_tooltip(pointFormat='<b>Proportion: </b> {point.percentage:,.2f}%') %>% 
  hc_title(text = 'Emissions by OSM landuse',
           style = list(fontSize = '15px', fontWeight = 'bold')) %>% 
  hc_credits(enabled = TRUE, text = '@ZoomCityCarbonModel')%>% 
  hc_exporting(enabled = TRUE)
```

# iStreets {data-orientation="rows" data-icon="fa-list"}

## Row {data-height="50"}

## Row 1 {data-height="500" data-width="400"}

### Top 20 tCO2 Emitter Streets

```{r fig.height=5}
#street <- fread("street.csv")

street <- df %>%
  group_by(name) %>%
  subset(name !="other") %>%
  summarise(tCO2 = round(sum(ECO2_gmh)/1000, digits= 2)) %>%
  arrange(desc(tCO2))

# Colors
custom_colors <- viridis::mako(n = length(street$name))

# Most emitter streets - treemap 
street %>% 
  head(20) %>% 
  hchart("treemap", hcaes(x = name, value = tCO2, color = tCO2), dataLabels = list(enabled = TRUE)) %>% 
  #hc_colorAxis(stops = color_stops(colors = viridis::viridis(20))) %>% 
  hc_credits(enabled = TRUE, text = '@ZoomCityCarbonModel') %>% 
  hc_exporting(enabled = TRUE) 

```

## Row 2 {data-height="900" data-width="800"}

### Find your street

```{r}
#find_street <- fread("find_street.csv")

find_street <- df %>%
  subset(name !="other") %>%
  dplyr::select(name, ECO2_gmh, ECO2_micro, EC_gmh, cars, speed, length, fclass, lanes,
                maxspeed, amenity, leisure, landuse, natural, shop) %>%
  head(100)


find_street %>% 
  datatable(
caption="Top 20 emitter streets",
rownames=T,
filter="top",
options = list(pageLength = 20
))

```

# Temporal Behaviour {data-orientation="rows" data-icon="fa-bar-chart"}

## Row {data-height="50"}

## Row {data-height="400"}

### 

```{r}
#hour <- fread("hour.csv")

hour <- df %>%
  group_by(date_hour) %>%
  summarise(ktCO2 = round(sum(ECO2_gmh)/1000/1000, digits= 2))

# Create tibble for our line plot.  

custom_colors <- viridis::viridis(n = length(hour$date_hour))

highchart() %>% 
    hc_add_series(hour, hcaes(x = date_hour, y = ktCO2, color = custom_colors), type = "line") %>%
    hc_tooltip(crosshairs = TRUE, borderWidth = 1.5, headerFormat = "", pointFormat = paste("Hour: <b>{point.x}</b> <br> ktCO2: <b>{point.y}</b>")) %>%
    hc_title(text = "Diurnal cycle") %>% 
    hc_subtitle(text = "Traffic emissions [ktCO2/month]") %>%
    hc_xAxis(title = list(text = "Hour of day")) %>%
    hc_yAxis(title = "",
             allowDecimals = FALSE,
             plotLines = list(list(
                    color = "black", width = 1, dashStyle = "Dash", 
                    value = mean(hour$ECO2),
                    label = list(text = "Mean = 6.2", 
                                 style = list(color = "black", fontSize = 14))))) %>%
    hc_legend(enabled = FALSE) %>% 
    hc_credits(enabled = TRUE, text = '@ZoomCityCarbonModel') %>% 
    hc_add_theme(hc_theme_hcrt()) %>% 
  hc_exporting(enabled = TRUE)

```

### 

```{r}
#week <- fread("week.csv")

week <- df %>%
  group_by(date_wday) %>%
  summarise(ktCO2 = round(sum(ECO2_gmh)/1000/1000, digits= 2))

# Colors
#custom_colors <- viridis::viridis(n = length(week$date_wday))

# Labels
wday_lables <- c("Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday")

# BY weeks
week %>%
  hchart('lollipop', hcaes(x = wday_lables , y = ktCO2, color = ktCO2)) %>% 
  hc_add_theme(hc_theme_hcrt()) %>%
  hc_tooltip(pointFormat = '<b>ktCO2: </b> {point.y} <br>') %>% 
  hc_yAxis(title = list(text = '')) %>% 
  hc_xAxis(title = list(text = '')) %>% 
  hc_title(text = 'By Weekday',
           style = list(fontSize = '25px', fontWeight = 'bold')) %>% 
  hc_subtitle(text = 'Traffic emissions [ktCO2/month]',
              style = list(fontSize = '16px')) %>% 
  hc_credits(enabled = TRUE, text = '@ZoomCityCarbonModel') %>% 
  hc_exporting(enabled = TRUE)

```

# About {data-icon="fa-info-circle"}

## Column

### 

**Thank You** for checking out my first ZoomCityCO2model Interactive FlexDashboard in R!

Any feedback is welcome!
